{% extends "base.html" %}
{% block title %}VibeMatch - ML Song Discovery{% endblock %}

{% block content %}
<style>
    :root {
        --primary: #1DB954;
        --primary-dark: #1aa34a;
        --bg-dark: #121212;
        --bg-card: #181818;
        --bg-hover: #282828;
        --text-primary: #ffffff;
        --text-secondary: #b3b3b3;
        --border-color: #333;
    }

    body {
        background-color: var(--bg-dark);
        color: var(--text-primary);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .hero-section {
        text-align: center;
        padding: 40px 20px;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-radius: 12px;
        margin-bottom: 30px;
    }

    .hero-section h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        background: linear-gradient(90deg, #1DB954, #1ed760);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .hero-section p {
        color: var(--text-secondary);
        font-size: 1.1rem;
    }

    .ml-badge {
        display: inline-block;
        background: var(--primary);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        margin-left: 10px;
    }

    /* Configuration Panel */
    .config-panel {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid var(--border-color);
    }

    .config-panel h2 {
        margin-bottom: 20px;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
        margin-bottom: 25px;
    }

    .config-item {
        background: var(--bg-hover);
        padding: 20px;
        border-radius: 8px;
    }

    .config-item label {
        display: block;
        margin-bottom: 12px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .config-item .description {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 15px;
    }

    .slider-container {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .slider-container input[type="range"] {
        flex: 1;
        height: 6px;
        -webkit-appearance: none;
        background: #404040;
        border-radius: 3px;
        outline: none;
    }

    .slider-container input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        background: var(--primary);
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .slider-container input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.2);
    }

    .slider-value {
        background: var(--primary);
        color: white;
        padding: 5px 12px;
        border-radius: 6px;
        font-weight: bold;
        min-width: 60px;
        text-align: center;
    }

    select {
        width: 100%;
        padding: 12px;
        background: var(--bg-dark);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
    }

    select:focus {
        outline: none;
        border-color: var(--primary);
    }

    .run-btn {
        width: 100%;
        padding: 16px 32px;
        font-size: 1.1rem;
        font-weight: bold;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .run-btn:hover:not(:disabled) {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(29, 185, 84, 0.4);
    }

    .run-btn:disabled {
        background: #404040;
        cursor: not-allowed;
    }

    .run-btn .spinner {
        display: none;
        width: 20px;
        height: 20px;
        border: 3px solid transparent;
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .run-btn.loading .spinner {
        display: block;
    }

    .run-btn.loading .btn-text {
        display: none;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Pipeline Steps */
    .pipeline-section {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid var(--border-color);
    }

    .pipeline-section h2 {
        margin-bottom: 20px;
        font-size: 1.3rem;
    }

    .pipeline-steps {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .pipeline-step {
        background: var(--bg-hover);
        border-radius: 8px;
        padding: 20px;
        display: grid;
        grid-template-columns: 40px 1fr auto;
        gap: 15px;
        align-items: center;
        transition: all 0.3s;
        border: 1px solid transparent;
    }

    .pipeline-step.active {
        border-color: var(--primary);
        background: rgba(29, 185, 84, 0.1);
    }

    .pipeline-step.completed {
        border-color: var(--primary);
    }

    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #404040;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: all 0.3s;
    }

    .pipeline-step.active .step-number,
    .pipeline-step.completed .step-number {
        background: var(--primary);
    }

    .step-info h3 {
        margin: 0 0 5px 0;
        font-size: 1rem;
    }

    .step-info p {
        margin: 0;
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .step-progress {
        width: 120px;
    }

    .progress-bar {
        height: 8px;
        background: #404040;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: var(--primary);
        border-radius: 4px;
        transition: width 0.3s;
        width: 0%;
    }

    .progress-text {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 5px;
        text-align: right;
    }

    /* Metrics Panel */
    .metrics-panel {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid var(--border-color);
        display: none;
    }

    .metrics-panel.visible {
        display: block;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }

    .metric-card {
        background: var(--bg-hover);
        padding: 15px;
        border-radius: 8px;
        text-align: center;
    }

    .metric-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary);
    }

    .metric-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 5px;
    }

    /* Vibes/Clusters Display */
    .vibes-section {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid var(--border-color);
        display: none;
    }

    .vibes-section.visible {
        display: block;
    }

    .vibes-section h2 {
        margin-bottom: 10px;
        font-size: 1.3rem;
    }

    .vibes-section > p {
        color: var(--text-secondary);
        margin-bottom: 20px;
    }

    .vibes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }

    .vibe-card {
        background: var(--bg-hover);
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid transparent;
    }

    .vibe-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .vibe-card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #000;
    }

    .vibe-card-info {
        padding: 15px;
    }

    .vibe-card-info h3 {
        margin: 0 0 8px 0;
        font-size: 1.1rem;
    }

    .vibe-card-info p {
        margin: 0;
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .song-count-badge {
        display: inline-block;
        background: var(--primary);
        color: white;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        margin-top: 8px;
    }

    /* Song Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal-overlay.visible {
        display: flex;
    }

    .modal-content {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
        from {
            opacity: 0;
            transform: scale(0.9);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .modal-content img {
        width: 200px;
        height: 200px;
        border-radius: 8px;
        margin-bottom: 20px;
        object-fit: cover;
    }

    .modal-content h3 {
        margin: 0 0 5px 0;
    }

    .modal-content p {
        color: var(--text-secondary);
        margin: 0 0 20px 0;
    }

    .spotify-btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background: var(--primary);
        color: white;
        padding: 12px 24px;
        border-radius: 30px;
        text-decoration: none;
        font-weight: bold;
        transition: all 0.3s;
    }

    .spotify-btn:hover {
        background: var(--primary-dark);
        transform: scale(1.05);
    }

    .modal-close {
        position: absolute;
        top: 15px;
        right: 20px;
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 1.5rem;
        cursor: pointer;
    }

    .modal-close:hover {
        color: white;
    }

    /* How It Works Section */
    .how-it-works {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-radius: 12px;
        padding: 30px;
        margin-top: 30px;
    }

    .how-it-works h2 {
        margin-bottom: 25px;
        text-align: center;
    }

    .steps-flow {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 20px;
    }

    .flow-step {
        flex: 1;
        min-width: 200px;
        text-align: center;
        padding: 20px;
    }

    .flow-step-icon {
        width: 60px;
        height: 60px;
        background: var(--primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        font-size: 1.5rem;
    }

    .flow-step h4 {
        margin: 0 0 10px 0;
    }

    .flow-step p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .flow-arrow {
        display: flex;
        align-items: center;
        color: var(--primary);
        font-size: 1.5rem;
    }

    @media (max-width: 768px) {
        .flow-arrow {
            display: none;
        }
    }

    /* Loading states */
    .loading-skeleton {
        background: linear-gradient(90deg, #2a2a2a 25%, #3a3a3a 50%, #2a2a2a 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 8px;
    }

    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
</style>

<!-- Hero Section -->
<div class="hero-section">
    <h1>VibeMatch <span class="ml-badge">ML Powered</span></h1>
    <p>Discover songs through AI-driven lyrical analysis and clustering</p>
</div>

<!-- Configuration Panel -->
<div class="config-panel">
    <h2>
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
        Configure ML Pipeline
    </h2>

    <div class="config-grid">
        <div class="config-item">
            <label for="sampleSize">Sample Size</label>
            <div class="description">Number of songs to analyze. Smaller = faster, larger = more diverse clusters.</div>
            <div class="slider-container">
                <input type="range" id="sampleSize" min="100" max="2000" value="500" step="100">
                <span class="slider-value" id="sampleSizeValue">500</span>
            </div>
        </div>

        <div class="config-item">
            <label for="numClusters">Number of Vibes (Clusters)</label>
            <div class="description">How many distinct "vibes" to create from the lyrics.</div>
            <div class="slider-container">
                <input type="range" id="numClusters" min="2" max="10" value="4" step="1">
                <span class="slider-value" id="numClustersValue">4</span>
            </div>
        </div>

        <div class="config-item">
            <label for="modelSelect">BERT Model</label>
            <div class="description">Choose the embedding model. Faster models work well for demos.</div>
            <select id="modelSelect">
                <option value="all-MiniLM-L6-v2">MiniLM (Fast) - 384 dims</option>
                <option value="all-mpnet-base-v2">MPNet (Balanced) - 768 dims</option>
                <option value="bert-base-nli-mean-tokens">BERT NLI (Original) - 768 dims</option>
            </select>
        </div>
    </div>

    <button class="run-btn" id="runPipelineBtn" onclick="runPipeline()">
        <span class="btn-text">Run ML Pipeline</span>
        <div class="spinner"></div>
    </button>
</div>

<!-- Pipeline Steps Visualization -->
<div class="pipeline-section">
    <h2>ML Pipeline Progress</h2>
    <div class="pipeline-steps">
        <div class="pipeline-step" id="step1">
            <div class="step-number">1</div>
            <div class="step-info">
                <h3>Data Loading</h3>
                <p id="step1-message">Sample lyrics from dataset</p>
            </div>
            <div class="step-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="step1-progress"></div>
                </div>
                <div class="progress-text" id="step1-percent">0%</div>
            </div>
        </div>

        <div class="pipeline-step" id="step2">
            <div class="step-number">2</div>
            <div class="step-info">
                <h3>BERT Encoding</h3>
                <p id="step2-message">Generate semantic embeddings</p>
            </div>
            <div class="step-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="step2-progress"></div>
                </div>
                <div class="progress-text" id="step2-percent">0%</div>
            </div>
        </div>

        <div class="pipeline-step" id="step3">
            <div class="step-number">3</div>
            <div class="step-info">
                <h3>KMeans Clustering</h3>
                <p id="step3-message">Group similar lyrics into vibes</p>
            </div>
            <div class="step-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="step3-progress"></div>
                </div>
                <div class="progress-text" id="step3-percent">0%</div>
            </div>
        </div>

        <div class="pipeline-step" id="step4">
            <div class="step-number">4</div>
            <div class="step-info">
                <h3>WordCloud Generation</h3>
                <p id="step4-message">Create visual representations</p>
            </div>
            <div class="step-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="step4-progress"></div>
                </div>
                <div class="progress-text" id="step4-percent">0%</div>
            </div>
        </div>
    </div>
</div>

<!-- Metrics Panel -->
<div class="metrics-panel" id="metricsPanel">
    <h2>ML Metrics</h2>
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-value" id="metricSongs">-</div>
            <div class="metric-label">Songs Analyzed</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="metricClusters">-</div>
            <div class="metric-label">Clusters Created</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="metricDimensions">-</div>
            <div class="metric-label">Embedding Dims</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="metricSilhouette">-</div>
            <div class="metric-label">Silhouette Score</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="metricTime">-</div>
            <div class="metric-label">Total Time (s)</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="metricModel">-</div>
            <div class="metric-label">Model Used</div>
        </div>
    </div>
</div>

<!-- Vibes Section -->
<div class="vibes-section" id="vibesSection">
    <h2>Generated Vibes</h2>
    <p>Click on a vibe to discover a random song from that cluster!</p>
    <div class="vibes-grid" id="vibesGrid">
        <!-- Dynamically populated -->
    </div>
</div>

<!-- Song Modal -->
<div class="modal-overlay" id="songModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <img id="modalAlbumArt" src="" alt="Album Art">
        <h3 id="modalSongName">Song Name</h3>
        <p id="modalArtistName">Artist Name</p>
        <a id="modalSpotifyLink" href="#" target="_blank" class="spotify-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
            </svg>
            Play on Spotify
        </a>
    </div>
</div>

<!-- How It Works -->
<div class="how-it-works">
    <h2>How VibeMatch Works</h2>
    <div class="steps-flow">
        <div class="flow-step">
            <div class="flow-step-icon">1</div>
            <h4>BERT Encoding</h4>
            <p>A pre-trained BERT model encodes song lyrics into high-dimensional semantic vectors</p>
        </div>
        <div class="flow-arrow">&rarr;</div>
        <div class="flow-step">
            <div class="flow-step-icon">2</div>
            <h4>KMeans Clustering</h4>
            <p>Vectors are grouped into clusters using KMeans algorithm based on lyrical similarity</p>
        </div>
        <div class="flow-arrow">&rarr;</div>
        <div class="flow-step">
            <div class="flow-step-icon">3</div>
            <h4>WordCloud Vibes</h4>
            <p>Each cluster's common words form a visual "vibe" representation</p>
        </div>
        <div class="flow-arrow">&rarr;</div>
        <div class="flow-step">
            <div class="flow-step-icon">4</div>
            <h4>Spotify Integration</h4>
            <p>Click any vibe to play a random song from that cluster on Spotify</p>
        </div>
    </div>
</div>

<script>
    // State
    let currentSessionId = null;
    let eventSource = null;

    // Slider value updates
    document.getElementById('sampleSize').addEventListener('input', function() {
        document.getElementById('sampleSizeValue').textContent = this.value;
    });

    document.getElementById('numClusters').addEventListener('input', function() {
        document.getElementById('numClustersValue').textContent = this.value;
    });

    // Reset pipeline UI
    function resetPipelineUI() {
        for (let i = 1; i <= 4; i++) {
            document.getElementById(`step${i}`).classList.remove('active', 'completed');
            document.getElementById(`step${i}-progress`).style.width = '0%';
            document.getElementById(`step${i}-percent`).textContent = '0%';
        }
        document.getElementById('step1-message').textContent = 'Sample lyrics from dataset';
        document.getElementById('step2-message').textContent = 'Generate semantic embeddings';
        document.getElementById('step3-message').textContent = 'Group similar lyrics into vibes';
        document.getElementById('step4-message').textContent = 'Create visual representations';

        document.getElementById('metricsPanel').classList.remove('visible');
        document.getElementById('vibesSection').classList.remove('visible');
    }

    // Run pipeline
    async function runPipeline() {
        const btn = document.getElementById('runPipelineBtn');
        btn.classList.add('loading');
        btn.disabled = true;

        resetPipelineUI();

        const params = {
            n_samples: parseInt(document.getElementById('sampleSize').value),
            n_clusters: parseInt(document.getElementById('numClusters').value),
            model_name: document.getElementById('modelSelect').value
        };

        try {
            // Start pipeline
            const response = await fetch('/api/run_pipeline', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            });

            const data = await response.json();
            currentSessionId = data.session_id;

            // Connect to SSE for updates
            connectToStream(currentSessionId);

        } catch (error) {
            console.error('Error starting pipeline:', error);
            btn.classList.remove('loading');
            btn.disabled = false;
            alert('Error starting pipeline: ' + error.message);
        }
    }

    // Connect to SSE stream
    function connectToStream(sessionId) {
        if (eventSource) {
            eventSource.close();
        }

        eventSource = new EventSource(`/api/pipeline_stream/${sessionId}`);

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.status === 'running') {
                updateProgress(data);
            } else if (data.status === 'completed') {
                eventSource.close();
                handleCompletion(data);
            } else if (data.status === 'timeout') {
                eventSource.close();
                handleError('Pipeline timed out');
            }
        };

        eventSource.onerror = function() {
            // Poll for final result on error
            setTimeout(() => checkFinalResult(sessionId), 1000);
        };
    }

    // Update progress UI
    function updateProgress(data) {
        const stepNum = data.step_number;
        const progress = Math.round(data.progress);

        // Update all steps
        for (let i = 1; i <= 4; i++) {
            const stepEl = document.getElementById(`step${i}`);
            if (i < stepNum) {
                stepEl.classList.remove('active');
                stepEl.classList.add('completed');
                document.getElementById(`step${i}-progress`).style.width = '100%';
                document.getElementById(`step${i}-percent`).textContent = '100%';
            } else if (i === stepNum) {
                stepEl.classList.add('active');
                stepEl.classList.remove('completed');
                document.getElementById(`step${i}-progress`).style.width = progress + '%';
                document.getElementById(`step${i}-percent`).textContent = progress + '%';
                document.getElementById(`step${i}-message`).textContent = data.message;
            }
        }
    }

    // Handle pipeline completion
    function handleCompletion(data) {
        const btn = document.getElementById('runPipelineBtn');
        btn.classList.remove('loading');
        btn.disabled = false;

        // Mark all steps complete
        for (let i = 1; i <= 4; i++) {
            document.getElementById(`step${i}`).classList.remove('active');
            document.getElementById(`step${i}`).classList.add('completed');
            document.getElementById(`step${i}-progress`).style.width = '100%';
            document.getElementById(`step${i}-percent`).textContent = '100%';
        }

        if (data.success) {
            displayMetrics(data.metrics);
            displayVibes(data.clusters);
        } else {
            handleError(data.error || 'Pipeline failed');
        }
    }

    // Check final result via polling
    async function checkFinalResult(sessionId) {
        try {
            const response = await fetch(`/api/pipeline_status/${sessionId}`);
            const data = await response.json();

            if (data.status === 'completed') {
                handleCompletion(data);
            } else if (data.status === 'running') {
                updateProgress(data);
                setTimeout(() => checkFinalResult(sessionId), 1000);
            }
        } catch (error) {
            console.error('Error checking result:', error);
        }
    }

    // Display metrics
    function displayMetrics(metrics) {
        document.getElementById('metricSongs').textContent = metrics.total_songs || '-';
        document.getElementById('metricClusters').textContent = metrics.n_clusters || '-';
        document.getElementById('metricDimensions').textContent = metrics.embedding_dimensions || '-';
        document.getElementById('metricSilhouette').textContent =
            metrics.silhouette_score ? metrics.silhouette_score.toFixed(3) : '-';
        document.getElementById('metricTime').textContent =
            metrics.total_time ? metrics.total_time.toFixed(1) : '-';
        document.getElementById('metricModel').textContent = metrics.model_used || '-';

        document.getElementById('metricsPanel').classList.add('visible');
    }

    // Display vibes
    function displayVibes(clusters) {
        const grid = document.getElementById('vibesGrid');
        grid.innerHTML = '';

        clusters.forEach((cluster, index) => {
            const card = document.createElement('div');
            card.className = 'vibe-card';
            card.onclick = () => playVibesSong(cluster.id);

            card.innerHTML = `
                <img src="data:image/png;base64,${cluster.wordcloud}" alt="Vibe ${index + 1}">
                <div class="vibe-card-info">
                    <h3>Vibe ${index + 1}</h3>
                    <p>${cluster.sample_songs.slice(0, 2).map(s => s.song_title).join(', ')}...</p>
                    <span class="song-count-badge">${cluster.song_count} songs</span>
                </div>
            `;

            grid.appendChild(card);
        });

        document.getElementById('vibesSection').classList.add('visible');
    }

    // Play song from vibe
    async function playVibesSong(clusterId) {
        try {
            const response = await fetch('/api/vibe_dynamic', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: currentSessionId,
                    cluster_id: clusterId
                })
            });

            const data = await response.json();

            if (data.success) {
                showSongModal(data);
            } else {
                alert('Could not find song on Spotify: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error playing song:', error);
            alert('Error: ' + error.message);
        }
    }

    // Show song modal
    function showSongModal(data) {
        document.getElementById('modalAlbumArt').src = data.album_art || '';
        document.getElementById('modalSongName').textContent = data.song_name;
        document.getElementById('modalArtistName').textContent = data.artist_name;
        document.getElementById('modalSpotifyLink').href = data.spotify_url;
        document.getElementById('songModal').classList.add('visible');
    }

    // Close modal
    function closeModal() {
        document.getElementById('songModal').classList.remove('visible');
    }

    // Close modal on overlay click
    document.getElementById('songModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // Handle errors
    function handleError(message) {
        const btn = document.getElementById('runPipelineBtn');
        btn.classList.remove('loading');
        btn.disabled = false;
        alert('Error: ' + message);
    }
</script>

{% endblock %}
